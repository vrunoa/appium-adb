"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _teen_process = require("teen_process");

var _logger = _interopRequireDefault(require("../logger.js"));

var _path = _interopRequireDefault(require("path"));

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumSupport = require("appium-support");

var _lruCache = _interopRequireDefault(require("lru-cache"));

var _helpers = require("../helpers.js");

var _asyncLock = _interopRequireDefault(require("async-lock"));

const BASE_APK = 'base-master.apk';

const LANGUAGE_APK = lang => `base-${lang}.apk`;

const APKS_CACHE = new _lruCache.default({
  max: 10,
  dispose: (apksHash, extractedFilesRoot) => _appiumSupport.fs.rimraf(extractedFilesRoot)
});
const APKS_CACHE_GUARD = new _asyncLock.default();

function extractFromApks(_x, _x2) {
  return _extractFromApks.apply(this, arguments);
}

function _extractFromApks() {
  _extractFromApks = (0, _asyncToGenerator2.default)(function* (apks, dstPath) {
    if (!_lodash.default.isArray(dstPath)) {
      dstPath = [dstPath];
    }

    return yield APKS_CACHE_GUARD.acquire(apks, (0, _asyncToGenerator2.default)(function* () {
      const apksHash = yield _appiumSupport.fs.hash(apks);

      _logger.default.debug(`Calculated '${apks}' hash: ${apksHash}`);

      if (APKS_CACHE.has(apksHash)) {
        const resultPath = _path.default.resolve(APKS_CACHE.get(apksHash), ...dstPath);

        if (yield _appiumSupport.fs.exists(resultPath)) {
          return resultPath;
        }

        APKS_CACHE.del(apksHash);
      }

      const tmpRoot = yield _appiumSupport.tempDir.openDir();

      _logger.default.debug(`Unpacking application bundle at '${apks}' to '${tmpRoot}'`);

      yield (0, _helpers.unzipFile)(apks, tmpRoot);

      const resultPath = _path.default.resolve(tmpRoot, ...dstPath);

      if (!(yield _appiumSupport.fs.exists(resultPath))) {
        throw new Error(`${dstPath.join(_path.default.sep)} cannot be found in '${apks}' bundle. ` + `Does the archive contain a valid application bundle?`);
      }

      APKS_CACHE.set(apksHash, tmpRoot);
      return resultPath;
    }));
  });
  return _extractFromApks.apply(this, arguments);
}

let apksUtilsMethods = {};

apksUtilsMethods.execBundletool = function () {
  var _ref = (0, _asyncToGenerator2.default)(function* (args, errorMsg) {
    yield this.initBundletool();
    args = ['-jar', this.binaries.bundletool, ...args];

    _logger.default.debug(`Executing bundletool with arguments: ${JSON.stringify(args)}`);

    let stdout;

    try {
      var _ref2 = yield (0, _teen_process.exec)((0, _helpers.getJavaForOs)(), args);

      stdout = _ref2.stdout;

      _logger.default.debug(`Command stdout: ${_lodash.default.truncate(stdout, {
        length: 300
      })}`);

      return stdout;
    } catch (e) {
      if (e.stdout) {
        _logger.default.debug(`Command stdout: ${e.stdout}`);
      }

      if (e.stderr) {
        _logger.default.debug(`Command stderr: ${e.stderr}`);
      }

      throw new Error(`${errorMsg}. Original error: ${e.message}`);
    }
  });

  return function (_x3, _x4) {
    return _ref.apply(this, arguments);
  };
}();

apksUtilsMethods.getDeviceSpec = function () {
  var _ref3 = (0, _asyncToGenerator2.default)(function* (specLocation) {
    const args = ['get-device-spec', '--adb', this.executable.path, '--device-id', this.curDeviceId, '--output', specLocation];

    _logger.default.debug(`Getting the spec for the device '${this.curDeviceId}'`);

    yield this.execBundletool(args, 'Cannot retrieve the device spec');
    return specLocation;
  });

  return function (_x5) {
    return _ref3.apply(this, arguments);
  };
}();

apksUtilsMethods.installApks = function () {
  var _ref4 = (0, _asyncToGenerator2.default)(function* (apks, options = {}) {
    options = Object.assign({
      timeout: _helpers.APKS_INSTALL_TIMEOUT
    }, options, {
      replace: true
    });
    const tmpRoot = yield _appiumSupport.tempDir.openDir();

    try {
      const specPath = yield this.getDeviceSpec(_path.default.resolve(tmpRoot, 'deviceSpec.json'));
      const args = ['extract-apks', '--apks', apks, '--output-dir', tmpRoot, '--device-spec', specPath];

      _logger.default.debug(`Extracting the apk files from '${apks}'`);

      yield this.execBundletool(args, `Cannot extract the application bundle at '${apks}'`);
      const installArgs = (0, _helpers.buildInstallArgs)((yield this.getApiLevel()), options);
      const apkPathsToInstall = (yield _appiumSupport.fs.readdir(tmpRoot)).filter(name => name.endsWith(_helpers.APK_EXTENSION)).map(name => _path.default.resolve(tmpRoot, name));

      _logger.default.debug('Got the following apk files to install: ' + JSON.stringify(apkPathsToInstall.map(x => _path.default.basename(x))));

      const output = yield this.adbExec(['install-multiple', ...installArgs, ...apkPathsToInstall], {
        timeout: options.timeout
      });
      const truncatedOutput = !_lodash.default.isString(output) || output.length <= 300 ? output : `${output.substr(0, 150)}...${output.substr(output.length - 150)}`;

      _logger.default.debug(`Install command stdout: ${truncatedOutput}`);

      if (_lodash.default.includes(output, 'INSTALL_FAILED')) {
        throw new Error(output);
      }
    } finally {
      yield _appiumSupport.fs.rimraf(tmpRoot);
    }
  });

  return function (_x6) {
    return _ref4.apply(this, arguments);
  };
}();

apksUtilsMethods.extractBaseApk = function () {
  var _ref5 = (0, _asyncToGenerator2.default)(function* (apks) {
    return yield extractFromApks(apks, ['splits', BASE_APK]);
  });

  return function (_x7) {
    return _ref5.apply(this, arguments);
  };
}();

apksUtilsMethods.extractLanguageApk = function () {
  var _ref6 = (0, _asyncToGenerator2.default)(function* (apks, language = null) {
    if (language) {
      try {
        return yield extractFromApks(apks, ['splits', LANGUAGE_APK(language)]);
      } catch (e) {
        _logger.default.debug(e.message);

        _logger.default.info(`Assuming that splitting by language is not enabled for the '${apks}' bundle ` + `and returning the main apk instead`);

        return yield this.extractBaseApk(apks);
      }
    }

    const defaultLanguages = ['en', 'en_us'];

    for (var _i = 0; _i < defaultLanguages.length; _i++) {
      const lang = defaultLanguages[_i];

      try {
        return yield extractFromApks(apks, ['splits', LANGUAGE_APK(lang)]);
      } catch (ign) {}
    }

    _logger.default.info(`Cannot find any split apk for the default languages ${JSON.stringify(defaultLanguages)}. ` + `Returning the main apk instead.`);

    return yield this.extractBaseApk(apks);
  });

  return function (_x8) {
    return _ref6.apply(this, arguments);
  };
}();

var _default = apksUtilsMethods;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi90b29scy9hcGtzLXV0aWxzLmpzIl0sIm5hbWVzIjpbIkJBU0VfQVBLIiwiTEFOR1VBR0VfQVBLIiwibGFuZyIsIkFQS1NfQ0FDSEUiLCJMUlUiLCJtYXgiLCJkaXNwb3NlIiwiYXBrc0hhc2giLCJleHRyYWN0ZWRGaWxlc1Jvb3QiLCJmcyIsInJpbXJhZiIsIkFQS1NfQ0FDSEVfR1VBUkQiLCJBc3luY0xvY2siLCJleHRyYWN0RnJvbUFwa3MiLCJhcGtzIiwiZHN0UGF0aCIsIl8iLCJpc0FycmF5IiwiYWNxdWlyZSIsImhhc2giLCJsb2ciLCJkZWJ1ZyIsImhhcyIsInJlc3VsdFBhdGgiLCJwYXRoIiwicmVzb2x2ZSIsImdldCIsImV4aXN0cyIsImRlbCIsInRtcFJvb3QiLCJ0ZW1wRGlyIiwib3BlbkRpciIsIkVycm9yIiwiam9pbiIsInNlcCIsInNldCIsImFwa3NVdGlsc01ldGhvZHMiLCJleGVjQnVuZGxldG9vbCIsImFyZ3MiLCJlcnJvck1zZyIsImluaXRCdW5kbGV0b29sIiwiYmluYXJpZXMiLCJidW5kbGV0b29sIiwiSlNPTiIsInN0cmluZ2lmeSIsInN0ZG91dCIsInRydW5jYXRlIiwibGVuZ3RoIiwiZSIsInN0ZGVyciIsIm1lc3NhZ2UiLCJnZXREZXZpY2VTcGVjIiwic3BlY0xvY2F0aW9uIiwiZXhlY3V0YWJsZSIsImN1ckRldmljZUlkIiwiaW5zdGFsbEFwa3MiLCJvcHRpb25zIiwiT2JqZWN0IiwiYXNzaWduIiwidGltZW91dCIsIkFQS1NfSU5TVEFMTF9USU1FT1VUIiwicmVwbGFjZSIsInNwZWNQYXRoIiwiaW5zdGFsbEFyZ3MiLCJnZXRBcGlMZXZlbCIsImFwa1BhdGhzVG9JbnN0YWxsIiwicmVhZGRpciIsImZpbHRlciIsIm5hbWUiLCJlbmRzV2l0aCIsIkFQS19FWFRFTlNJT04iLCJtYXAiLCJ4IiwiYmFzZW5hbWUiLCJvdXRwdXQiLCJhZGJFeGVjIiwidHJ1bmNhdGVkT3V0cHV0IiwiaXNTdHJpbmciLCJzdWJzdHIiLCJpbmNsdWRlcyIsImV4dHJhY3RCYXNlQXBrIiwiZXh0cmFjdExhbmd1YWdlQXBrIiwibGFuZ3VhZ2UiLCJpbmZvIiwiZGVmYXVsdExhbmd1YWdlcyIsImlnbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHQTs7QUFFQSxNQUFNQSxRQUFRLEdBQUcsaUJBQWpCOztBQUNBLE1BQU1DLFlBQVksR0FBSUMsSUFBRCxJQUFXLFFBQU9BLElBQUssTUFBNUM7O0FBQ0EsTUFBTUMsVUFBVSxHQUFHLElBQUlDLGlCQUFKLENBQVE7QUFDekJDLEVBQUFBLEdBQUcsRUFBRSxFQURvQjtBQUV6QkMsRUFBQUEsT0FBTyxFQUFFLENBQUNDLFFBQUQsRUFBV0Msa0JBQVgsS0FBa0NDLGtCQUFHQyxNQUFILENBQVVGLGtCQUFWO0FBRmxCLENBQVIsQ0FBbkI7QUFJQSxNQUFNRyxnQkFBZ0IsR0FBRyxJQUFJQyxrQkFBSixFQUF6Qjs7U0FlZUMsZTs7Ozs7cURBQWYsV0FBZ0NDLElBQWhDLEVBQXNDQyxPQUF0QyxFQUErQztBQUM3QyxRQUFJLENBQUNDLGdCQUFFQyxPQUFGLENBQVVGLE9BQVYsQ0FBTCxFQUF5QjtBQUN2QkEsTUFBQUEsT0FBTyxHQUFHLENBQUNBLE9BQUQsQ0FBVjtBQUNEOztBQUVELGlCQUFhSixnQkFBZ0IsQ0FBQ08sT0FBakIsQ0FBeUJKLElBQXpCLGtDQUErQixhQUFZO0FBSXRELFlBQU1QLFFBQVEsU0FBU0Usa0JBQUdVLElBQUgsQ0FBUUwsSUFBUixDQUF2Qjs7QUFDQU0sc0JBQUlDLEtBQUosQ0FBVyxlQUFjUCxJQUFLLFdBQVVQLFFBQVMsRUFBakQ7O0FBRUEsVUFBSUosVUFBVSxDQUFDbUIsR0FBWCxDQUFlZixRQUFmLENBQUosRUFBOEI7QUFDNUIsY0FBTWdCLFVBQVUsR0FBR0MsY0FBS0MsT0FBTCxDQUFhdEIsVUFBVSxDQUFDdUIsR0FBWCxDQUFlbkIsUUFBZixDQUFiLEVBQXVDLEdBQUdRLE9BQTFDLENBQW5C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QUF1QztBQUMzRSxRQUFJQSxRQUFKLEVBQWM7QUFDWixVQUFJO0FBQ0YscUJBQWFyRSxlQUFlLENBQUNDLElBQUQsRUFBTyxDQUFDLFFBQUQsRUFBV2IsWUFBWSxDQUFDaUYsUUFBRCxDQUF2QixDQUFQLENBQTVCO0FBQ0QsT0FGRCxDQUVFLE9BQU9sQyxDQUFQLEVBQVU7QUFDVjVCLHdCQUFJQyxLQUFKLENBQVUyQixDQUFDLENBQUNFLE9BQVo7O0FBQ0E5Qix3QkFBSStELElBQUosQ0FBVSwrREFBOERyRSxJQUFLLFdBQXBFLEdBQ04sb0NBREg7O0FBRUEscUJBQWEsS0FBS2tFLGNBQUwsQ0FBb0JsRSxJQUFwQixDQUFiO0FBQ0Q7QUFDRjs7QUFFRCxVQUFNc0UsZ0JBQWdCLEdBQUcsQ0FBQyxJQUFELEVBQU8sT0FBUCxDQUF6Qjs7QUFDQSwwQkFBbUJBLGdCQUFuQixlQUFxQztBQUFoQyxZQUFNbEYsSUFBSSxHQUFJa0YsZ0JBQUosSUFBVjs7QUFDSCxVQUFJO0FBQ0YscUJBQWF2RSxlQUFlLENBQUNDLElBQUQsRUFBTyxDQUFDLFFBQUQsRUFBV2IsWUFBWSxDQUFDQyxJQUFELENBQXZCLENBQVAsQ0FBNUI7QUFDRCxPQUZELENBRUUsT0FBT21GLEdBQVAsRUFBWSxDQUFFO0FBQ2pCOztBQUVEakUsb0JBQUkrRCxJQUFKLENBQVUsdURBQXNEeEMsSUFBSSxDQUFDQyxTQUFMLENBQWV3QyxnQkFBZixDQUFpQyxJQUF4RixHQUNOLGlDQURIOztBQUVBLGlCQUFhLEtBQUtKLGNBQUwsQ0FBb0JsRSxJQUFwQixDQUFiO0FBQ0QsR0F0QkQ7O0FBQUE7QUFBQTtBQUFBO0FBQUE7O2VBd0Jlc0IsZ0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyLmpzJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGZzLCB0ZW1wRGlyIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IExSVSBmcm9tICdscnUtY2FjaGUnO1xuaW1wb3J0IHtcbiAgZ2V0SmF2YUZvck9zLCB1bnppcEZpbGUsIGJ1aWxkSW5zdGFsbEFyZ3MsXG4gIEFQS1NfSU5TVEFMTF9USU1FT1VULCBBUEtfRVhURU5TSU9OIH0gZnJvbSAnLi4vaGVscGVycy5qcyc7XG5pbXBvcnQgQXN5bmNMb2NrIGZyb20gJ2FzeW5jLWxvY2snO1xuXG5jb25zdCBCQVNFX0FQSyA9ICdiYXNlLW1hc3Rlci5hcGsnO1xuY29uc3QgTEFOR1VBR0VfQVBLID0gKGxhbmcpID0+IGBiYXNlLSR7bGFuZ30uYXBrYDtcbmNvbnN0IEFQS1NfQ0FDSEUgPSBuZXcgTFJVKHtcbiAgbWF4OiAxMCxcbiAgZGlzcG9zZTogKGFwa3NIYXNoLCBleHRyYWN0ZWRGaWxlc1Jvb3QpID0+IGZzLnJpbXJhZihleHRyYWN0ZWRGaWxlc1Jvb3QpLFxufSk7XG5jb25zdCBBUEtTX0NBQ0hFX0dVQVJEID0gbmV3IEFzeW5jTG9jaygpO1xuXG4vKipcbiAqIEV4dHJhY3RzIHRoZSBwYXJ0aWN1bGFyIGFwa3MgcGFja2FnZSBpbnRvIGEgdGVtcG9yYXJ5IGZvbGRlcixcbiAqIGZpbmRzIGFuZCByZXR1cm5zIHRoZSBmdWxsIHBhdGggdG8gdGhlIGZpbGUgY29udGFpbmVkIGluIHRoaXMgYXBrLlxuICogVGhlIHJlc3VsdGluZyB0ZW1wb3JhcnkgcGF0aCwgd2hlcmUgdGhlIC5hcGtzIGZpbGUgaGFzIGJlZW4gZXh0cmFjdGVkLFxuICogd2lsbCBiZSBzdG9yZWQgaW50byB0aGUgaW50ZXJuYWwgTFJVIGNhY2hlIGZvciBiZXR0ZXIgcGVyZm9ybWFuY2UuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGFwa3MgLSBUaGUgZnVsbCBwYXRoIHRvIHRoZSAuYXBrcyBmaWxlXG4gKiBAcGFyYW0ge3N0cmluZ3xBcnJheTxTdHJpbmc+fSBkc3RQYXRoIC0gVGhlIHJlbGF0aXZlIHBhdGggdG8gdGhlIGRlc3RpbmF0aW9uIGZpbGUsXG4gKiB3aGljaCBpcyBnb2luZyB0byBiZSBleHRyYWN0ZWQsIHdoZXJlIGVhY2ggcGF0aCBjb21wb25lbnQgaXMgYW4gYXJyYXkgaXRlbVxuICogQHJldHVybnMge3N0cmluZ30gRnVsbCBwYXRoIHRvIHRoZSBleHRyYWN0ZWQgZmlsZVxuICogQHRocm93cyB7RXJyb3J9IElmIHRoZSByZXF1ZXN0ZWQgaXRlbSBkb2VzIG5vdCBleGlzdCBpbiB0aGUgZXh0cmFjdGVkIGFyY2hpdmUgb3IgdGhlIHByb3ZpZGVzXG4gKiBhcGtzIGZpbGUgaXMgbm90IGEgdmFsaWQgYnVuZGxlXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGV4dHJhY3RGcm9tQXBrcyAoYXBrcywgZHN0UGF0aCkge1xuICBpZiAoIV8uaXNBcnJheShkc3RQYXRoKSkge1xuICAgIGRzdFBhdGggPSBbZHN0UGF0aF07XG4gIH1cblxuICByZXR1cm4gYXdhaXQgQVBLU19DQUNIRV9HVUFSRC5hY3F1aXJlKGFwa3MsIGFzeW5jICgpID0+IHtcbiAgICAvLyBJdCBtaWdodCBiZSB0aGF0IHRoZSBvcmlnaW5hbCBmaWxlIGhhcyBiZWVuIHJlcGxhY2VkLFxuICAgIC8vIHNvIHdlIG5lZWQgdG8ga2VlcCB0aGUgaGFzaCBzdW1zIGluc3RlYWQgb2YgdGhlIGFjdHVhbCBmaWxlIHBhdGhzXG4gICAgLy8gYXMgY2FjaGluZyBrZXlzXG4gICAgY29uc3QgYXBrc0hhc2ggPSBhd2FpdCBmcy5oYXNoKGFwa3MpO1xuICAgIGxvZy5kZWJ1ZyhgQ2FsY3VsYXRlZCAnJHthcGtzfScgaGFzaDogJHthcGtzSGFzaH1gKTtcblxuICAgIGlmIChBUEtTX0NBQ0hFLmhhcyhhcGtzSGFzaCkpIHtcbiAgICAgIGNvbnN0IHJlc3VsdFBhdGggPSBwYXRoLnJlc29sdmUoQVBLU19DQUNIRS5nZXQoYXBrc0hhc2gpLCAuLi5kc3RQYXRoKTtcbiAgICAgIGlmIChhd2FpdCBmcy5leGlzdHMocmVzdWx0UGF0aCkpIHtcbiAgICAgICAgcmV0dXJuIHJlc3VsdFBhdGg7XG4gICAgICB9XG4gICAgICBBUEtTX0NBQ0hFLmRlbChhcGtzSGFzaCk7XG4gICAgfVxuXG4gICAgY29uc3QgdG1wUm9vdCA9IGF3YWl0IHRlbXBEaXIub3BlbkRpcigpO1xuICAgIGxvZy5kZWJ1ZyhgVW5wYWNraW5nIGFwcGxpY2F0aW9uIGJ1bmRsZSBhdCAnJHthcGtzfScgdG8gJyR7dG1wUm9vdH0nYCk7XG4gICAgYXdhaXQgdW56aXBGaWxlKGFwa3MsIHRtcFJvb3QpO1xuICAgIGNvbnN0IHJlc3VsdFBhdGggPSBwYXRoLnJlc29sdmUodG1wUm9vdCwgLi4uZHN0UGF0aCk7XG4gICAgaWYgKCFhd2FpdCBmcy5leGlzdHMocmVzdWx0UGF0aCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgJHtkc3RQYXRoLmpvaW4ocGF0aC5zZXApfSBjYW5ub3QgYmUgZm91bmQgaW4gJyR7YXBrc30nIGJ1bmRsZS4gYCArXG4gICAgICAgIGBEb2VzIHRoZSBhcmNoaXZlIGNvbnRhaW4gYSB2YWxpZCBhcHBsaWNhdGlvbiBidW5kbGU/YCk7XG4gICAgfVxuICAgIEFQS1NfQ0FDSEUuc2V0KGFwa3NIYXNoLCB0bXBSb290KTtcbiAgICByZXR1cm4gcmVzdWx0UGF0aDtcbiAgfSk7XG59XG5cbmxldCBhcGtzVXRpbHNNZXRob2RzID0ge307XG5cbi8qKlxuICogRXhlY3V0ZXMgYnVuZGxldG9vbCB1dGlsaXR5IHdpdGggZ2l2ZW4gYXJndW1lbnRzIGFuZCByZXR1cm5zIHRoZSBhY3R1YWwgc3Rkb3V0XG4gKlxuICogQHBhcmFtIHtBcnJheTxTdHJpbmc+fSBhcmdzIC0gdGhlIGxpc3Qgb2YgYnVuZGxldG9vbCBhcmd1bWVudHNcbiAqIEBwYXJhbSB7c3RyaW5nfSBlcnJvck1zZyAtIFRoZSBjdXN0b21pemVkIGVycm9yIG1lc3NhZ2Ugc3RyaW5nXG4gKiBAcmV0dXJucyB7c3RyaW5nfSB0aGUgYWN0dWFsIGNvbW1hbmQgc3Rkb3V0XG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgYnVuZGxldG9vbCBqYXIgZG9lcyBub3QgZXhpc3QgaW4gUEFUSCBvciB0aGVyZSB3YXMgYW4gZXJyb3Igd2hpbGVcbiAqIGV4ZWN1dGluZyBpdFxuICovXG5hcGtzVXRpbHNNZXRob2RzLmV4ZWNCdW5kbGV0b29sID0gYXN5bmMgZnVuY3Rpb24gKGFyZ3MsIGVycm9yTXNnKSB7XG4gIGF3YWl0IHRoaXMuaW5pdEJ1bmRsZXRvb2woKTtcbiAgYXJncyA9IFtcbiAgICAnLWphcicsIHRoaXMuYmluYXJpZXMuYnVuZGxldG9vbCxcbiAgICAuLi5hcmdzXG4gIF07XG4gIGxvZy5kZWJ1ZyhgRXhlY3V0aW5nIGJ1bmRsZXRvb2wgd2l0aCBhcmd1bWVudHM6ICR7SlNPTi5zdHJpbmdpZnkoYXJncyl9YCk7XG4gIGxldCBzdGRvdXQ7XG4gIHRyeSB7XG4gICAgKHtzdGRvdXR9ID0gYXdhaXQgZXhlYyhnZXRKYXZhRm9yT3MoKSwgYXJncykpO1xuICAgIGxvZy5kZWJ1ZyhgQ29tbWFuZCBzdGRvdXQ6ICR7Xy50cnVuY2F0ZShzdGRvdXQsIHtsZW5ndGg6IDMwMH0pfWApO1xuICAgIHJldHVybiBzdGRvdXQ7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBpZiAoZS5zdGRvdXQpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgQ29tbWFuZCBzdGRvdXQ6ICR7ZS5zdGRvdXR9YCk7XG4gICAgfVxuICAgIGlmIChlLnN0ZGVycikge1xuICAgICAgbG9nLmRlYnVnKGBDb21tYW5kIHN0ZGVycjogJHtlLnN0ZGVycn1gKTtcbiAgICB9XG4gICAgdGhyb3cgbmV3IEVycm9yKGAke2Vycm9yTXNnfS4gT3JpZ2luYWwgZXJyb3I6ICR7ZS5tZXNzYWdlfWApO1xuICB9XG59O1xuXG4vKipcbiAqIEBwYXJhbSB7c3RyaW5nfSBzcGVjTG9jYXRpb24gLSBUaGUgZnVsbCBwYXRoIHRvIHRoZSBnZW5lcmF0ZWQgZGV2aWNlIHNwZWMgbG9jYXRpb25cbiAqIEByZXR1cm5zIHtzdHJpbmd9IFRoZSBzYW1lIGBzcGVjTG9jYXRpb25gIHZhbHVlXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgaXQgaXMgbm90IHBvc3NpYmxlIHRvIHJldHJpZXZlIHRoZSBzcGVjIGZvciB0aGUgY3VycmVudCBkZXZpY2VcbiAqL1xuYXBrc1V0aWxzTWV0aG9kcy5nZXREZXZpY2VTcGVjID0gYXN5bmMgZnVuY3Rpb24gKHNwZWNMb2NhdGlvbikge1xuICBjb25zdCBhcmdzID0gW1xuICAgICdnZXQtZGV2aWNlLXNwZWMnLFxuICAgICctLWFkYicsIHRoaXMuZXhlY3V0YWJsZS5wYXRoLFxuICAgICctLWRldmljZS1pZCcsIHRoaXMuY3VyRGV2aWNlSWQsXG4gICAgJy0tb3V0cHV0Jywgc3BlY0xvY2F0aW9uLFxuICBdO1xuICBsb2cuZGVidWcoYEdldHRpbmcgdGhlIHNwZWMgZm9yIHRoZSBkZXZpY2UgJyR7dGhpcy5jdXJEZXZpY2VJZH0nYCk7XG4gIGF3YWl0IHRoaXMuZXhlY0J1bmRsZXRvb2woYXJncywgJ0Nhbm5vdCByZXRyaWV2ZSB0aGUgZGV2aWNlIHNwZWMnKTtcbiAgcmV0dXJuIHNwZWNMb2NhdGlvbjtcbn07XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gSW5zdGFsbEFwa3NPcHRpb25zXG4gKiBAcHJvcGVydHkgez9udW1iZXJ8c3RyaW5nfSB0aW1lb3V0IFsyMDAwMF0gLSBUaGUgbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyB0byB3YWl0IHVudGlsXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGUgaW5zdGFsbGF0aW9uIGlzIGNvbXBsZXRlZFxuICogQHByb3BlcnR5IHtib29sZWFufSBhbGxvd1Rlc3RQYWNrYWdlcyBbZmFsc2VdIC0gU2V0IHRvIHRydWUgaW4gb3JkZXIgdG8gYWxsb3cgdGVzdFxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFja2FnZXMgaW5zdGFsbGF0aW9uLlxuICogQHByb3BlcnR5IHtib29sZWFufSB1c2VTZGNhcmQgW2ZhbHNlXSAtIFNldCB0byB0cnVlIHRvIGluc3RhbGwgdGhlIGFwcCBvbiBzZGNhcmRcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnN0ZWFkIG9mIHRoZSBkZXZpY2UgbWVtb3J5LlxuICogQHByb3BlcnR5IHtib29sZWFufSBncmFudFBlcm1pc3Npb25zIFtmYWxzZV0gLSBTZXQgdG8gdHJ1ZSBpbiBvcmRlciB0byBncmFudCBhbGwgdGhlXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBlcm1pc3Npb25zIHJlcXVlc3RlZCBpbiB0aGUgYXBwbGljYXRpb24ncyBtYW5pZmVzdFxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdXRvbWF0aWNhbGx5IGFmdGVyIHRoZSBpbnN0YWxsYXRpb24gaXMgY29tcGxldGVkXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVuZGVyIEFuZHJvaWQgNisuXG4gKi9cblxuLyoqXG4gKiBJbnN0YWxscyB0aGUgZ2l2ZW4gLmFwa3MgcGFja2FnZSBpbnRvIHRoZSBkZXZpY2UgdW5kZXIgdGVzdFxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBhcGtzIC0gVGhlIGZ1bGwgcGF0aCB0byB0aGUgLmFwa3MgZmlsZVxuICogQHBhcmFtIHs/SW5zdGFsbEFwa3NPcHRpb25zfSBvcHRpb25zIC0gSW5zdGFsbGF0aW9uIG9wdGlvbnNcbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiB0aGUgLmFwa3MgYnVuZGxlIGNhbm5vdCBiZSBpbnN0YWxsZWRcbiAqL1xuYXBrc1V0aWxzTWV0aG9kcy5pbnN0YWxsQXBrcyA9IGFzeW5jIGZ1bmN0aW9uIChhcGtzLCBvcHRpb25zID0ge30pIHtcbiAgb3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oe1xuICAgIHRpbWVvdXQ6IEFQS1NfSU5TVEFMTF9USU1FT1VULFxuICB9LCBvcHRpb25zLCB7cmVwbGFjZTogdHJ1ZX0pO1xuXG4gIGNvbnN0IHRtcFJvb3QgPSBhd2FpdCB0ZW1wRGlyLm9wZW5EaXIoKTtcbiAgdHJ5IHtcbiAgICBjb25zdCBzcGVjUGF0aCA9IGF3YWl0IHRoaXMuZ2V0RGV2aWNlU3BlYyhwYXRoLnJlc29sdmUodG1wUm9vdCwgJ2RldmljZVNwZWMuanNvbicpKTtcbiAgICBjb25zdCBhcmdzID0gW1xuICAgICAgJ2V4dHJhY3QtYXBrcycsXG4gICAgICAnLS1hcGtzJywgYXBrcyxcbiAgICAgICctLW91dHB1dC1kaXInLCB0bXBSb290LFxuICAgICAgJy0tZGV2aWNlLXNwZWMnLCBzcGVjUGF0aCxcbiAgICBdO1xuICAgIGxvZy5kZWJ1ZyhgRXh0cmFjdGluZyB0aGUgYXBrIGZpbGVzIGZyb20gJyR7YXBrc30nYCk7XG4gICAgYXdhaXQgdGhpcy5leGVjQnVuZGxldG9vbChhcmdzLCBgQ2Fubm90IGV4dHJhY3QgdGhlIGFwcGxpY2F0aW9uIGJ1bmRsZSBhdCAnJHthcGtzfSdgKTtcbiAgICBjb25zdCBpbnN0YWxsQXJncyA9IGJ1aWxkSW5zdGFsbEFyZ3MoYXdhaXQgdGhpcy5nZXRBcGlMZXZlbCgpLCBvcHRpb25zKTtcbiAgICBjb25zdCBhcGtQYXRoc1RvSW5zdGFsbCA9IChhd2FpdCBmcy5yZWFkZGlyKHRtcFJvb3QpKVxuICAgICAgLmZpbHRlcigobmFtZSkgPT4gbmFtZS5lbmRzV2l0aChBUEtfRVhURU5TSU9OKSlcbiAgICAgIC5tYXAoKG5hbWUpID0+IHBhdGgucmVzb2x2ZSh0bXBSb290LCBuYW1lKSk7XG4gICAgbG9nLmRlYnVnKCdHb3QgdGhlIGZvbGxvd2luZyBhcGsgZmlsZXMgdG8gaW5zdGFsbDogJyArXG4gICAgICBKU09OLnN0cmluZ2lmeShhcGtQYXRoc1RvSW5zdGFsbC5tYXAoKHgpID0+IHBhdGguYmFzZW5hbWUoeCkpKSk7XG4gICAgY29uc3Qgb3V0cHV0ID0gYXdhaXQgdGhpcy5hZGJFeGVjKFsnaW5zdGFsbC1tdWx0aXBsZScsIC4uLmluc3RhbGxBcmdzLCAuLi5hcGtQYXRoc1RvSW5zdGFsbF0sIHtcbiAgICAgIHRpbWVvdXQ6IG9wdGlvbnMudGltZW91dCxcbiAgICB9KTtcbiAgICBjb25zdCB0cnVuY2F0ZWRPdXRwdXQgPSAoIV8uaXNTdHJpbmcob3V0cHV0KSB8fCBvdXRwdXQubGVuZ3RoIDw9IDMwMCkgP1xuICAgICAgb3V0cHV0IDogYCR7b3V0cHV0LnN1YnN0cigwLCAxNTApfS4uLiR7b3V0cHV0LnN1YnN0cihvdXRwdXQubGVuZ3RoIC0gMTUwKX1gO1xuICAgIGxvZy5kZWJ1ZyhgSW5zdGFsbCBjb21tYW5kIHN0ZG91dDogJHt0cnVuY2F0ZWRPdXRwdXR9YCk7XG4gICAgaWYgKF8uaW5jbHVkZXMob3V0cHV0LCAnSU5TVEFMTF9GQUlMRUQnKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKG91dHB1dCk7XG4gICAgfVxuICB9IGZpbmFsbHkge1xuICAgIGF3YWl0IGZzLnJpbXJhZih0bXBSb290KTtcbiAgfVxufTtcblxuLyoqXG4gKiBFeHRyYWN0cyBhbmQgcmV0dXJucyB0aGUgZnVsbCBwYXRoIHRvIHRoZSBtYXN0ZXIgLmFwayBmaWxlIGluc2lkZSB0aGUgYnVuZGxlLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBhcGtzIC0gVGhlIGZ1bGwgcGF0aCB0byB0aGUgLmFwa3MgZmlsZVxuICogQHJldHVybnMge3N0cmluZ30gVGhlIGZ1bGwgcGF0aCB0byB0aGUgbWFzdGVyIGJ1bmRsZSAuYXBrXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgdGhlcmUgd2FzIGFuIGVycm9yIHdoaWxlIGV4dHJhY3RpbmcvZmluZGluZyB0aGUgZmlsZVxuICovXG5hcGtzVXRpbHNNZXRob2RzLmV4dHJhY3RCYXNlQXBrID0gYXN5bmMgZnVuY3Rpb24gKGFwa3MpIHtcbiAgcmV0dXJuIGF3YWl0IGV4dHJhY3RGcm9tQXBrcyhhcGtzLCBbJ3NwbGl0cycsIEJBU0VfQVBLXSk7XG59O1xuXG4vKipcbiAqIEV4dHJhY3RzIGFuZCByZXR1cm5zIHRoZSBmdWxsIHBhdGggdG8gdGhlIC5hcGssIHdoaWNoIGNvbnRhaW5zIHRoZSBjb3JyZXNwb25kaW5nXG4gKiByZXNvdXJjZXMgZm9yIHRoZSBnaXZlbiBsYW5ndWFnZSBpbiB0aGUgLmFwa3MgYnVuZGxlLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBhcGtzIC0gVGhlIGZ1bGwgcGF0aCB0byB0aGUgLmFwa3MgZmlsZVxuICogQHBhcmFtIHs/c3RyaW5nfSBsYW5ndWFnZSAtIFRoZSBsYW5ndWFnZSBhYmJyZXZpYXRpb24uIFRoZSBkZWZhdWx0IGxhbmd1YWdlIGlzXG4gKiBnb2luZyB0byBiZSBzZWxlY3RlZCBpZiBpdCBpcyBub3Qgc2V0LlxuICogQHJldHVybnMge3N0cmluZ30gVGhlIGZ1bGwgcGF0aCB0byB0aGUgY29ycmVzcG9uZGluZyBsYW5ndWFnZSAuYXBrIG9yIHRoZSBtYXN0ZXIgLmFwa1xuICogaWYgbGFuZ3VhZ2Ugc3BsaXQgaXMgbm90IGVuYWJsZWQgZm9yIHRoZSBidW5kbGUuXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgdGhlcmUgd2FzIGFuIGVycm9yIHdoaWxlIGV4dHJhY3RpbmcvZmluZGluZyB0aGUgZmlsZVxuICovXG5hcGtzVXRpbHNNZXRob2RzLmV4dHJhY3RMYW5ndWFnZUFwayA9IGFzeW5jIGZ1bmN0aW9uIChhcGtzLCBsYW5ndWFnZSA9IG51bGwpIHtcbiAgaWYgKGxhbmd1YWdlKSB7XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiBhd2FpdCBleHRyYWN0RnJvbUFwa3MoYXBrcywgWydzcGxpdHMnLCBMQU5HVUFHRV9BUEsobGFuZ3VhZ2UpXSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgbG9nLmRlYnVnKGUubWVzc2FnZSk7XG4gICAgICBsb2cuaW5mbyhgQXNzdW1pbmcgdGhhdCBzcGxpdHRpbmcgYnkgbGFuZ3VhZ2UgaXMgbm90IGVuYWJsZWQgZm9yIHRoZSAnJHthcGtzfScgYnVuZGxlIGAgK1xuICAgICAgICBgYW5kIHJldHVybmluZyB0aGUgbWFpbiBhcGsgaW5zdGVhZGApO1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuZXh0cmFjdEJhc2VBcGsoYXBrcyk7XG4gICAgfVxuICB9XG5cbiAgY29uc3QgZGVmYXVsdExhbmd1YWdlcyA9IFsnZW4nLCAnZW5fdXMnXTtcbiAgZm9yIChjb25zdCBsYW5nIG9mIGRlZmF1bHRMYW5ndWFnZXMpIHtcbiAgICB0cnkge1xuICAgICAgcmV0dXJuIGF3YWl0IGV4dHJhY3RGcm9tQXBrcyhhcGtzLCBbJ3NwbGl0cycsIExBTkdVQUdFX0FQSyhsYW5nKV0pO1xuICAgIH0gY2F0Y2ggKGlnbikge31cbiAgfVxuXG4gIGxvZy5pbmZvKGBDYW5ub3QgZmluZCBhbnkgc3BsaXQgYXBrIGZvciB0aGUgZGVmYXVsdCBsYW5ndWFnZXMgJHtKU09OLnN0cmluZ2lmeShkZWZhdWx0TGFuZ3VhZ2VzKX0uIGAgK1xuICAgIGBSZXR1cm5pbmcgdGhlIG1haW4gYXBrIGluc3RlYWQuYCk7XG4gIHJldHVybiBhd2FpdCB0aGlzLmV4dHJhY3RCYXNlQXBrKGFwa3MpO1xufTtcblxuZXhwb3J0IGRlZmF1bHQgYXBrc1V0aWxzTWV0aG9kcztcbiJdLCJmaWxlIjoibGliL3Rvb2xzL2Fwa3MtdXRpbHMuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
