"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _chai = _interopRequireDefault(require("chai"));

var _chaiAsPromised = _interopRequireDefault(require("chai-as-promised"));

var _ = _interopRequireDefault(require("../.."));

var helpers = _interopRequireWildcard(require("../../lib/helpers.js"));

var _path = _interopRequireDefault(require("path"));

var teen_process = _interopRequireWildcard(require("teen_process"));

var appiumSupport = _interopRequireWildcard(require("appium-support"));

var _appiumTestSupport = require("appium-test-support");

_chai.default.use(_chaiAsPromised.default);

const selendroidTestApp = _path.default.resolve(helpers.rootDir, 'test', 'fixtures', 'selendroid-test-app.apk'),
      helperJarPath = _path.default.resolve(helpers.rootDir, 'jars'),
      keystorePath = _path.default.resolve(helpers.rootDir, 'test', 'fixtures', 'appiumtest.keystore'),
      defaultKeyPath = _path.default.resolve(helpers.rootDir, 'keys', 'testkey.pk8'),
      defaultCertPath = _path.default.resolve(helpers.rootDir, 'keys', 'testkey.x509.pem'),
      keyAlias = 'appiumtest',
      password = 'android',
      selendroidTestAppPackage = 'io.selendroid.testapp',
      javaDummyPath = 'java_dummy_path',
      javaHome = 'java_home',
      apksignerDummyPath = '/path/to/apksigner',
      tempDir = appiumSupport.tempDir,
      fs = appiumSupport.fs;

const adb = new _.default();
adb.keystorePath = keystorePath;
adb.keyAlias = keyAlias;
adb.keystorePassword = password;
adb.keyPassword = password;
describe('signing', (0, _appiumTestSupport.withMocks)({
  teen_process,
  helpers,
  adb,
  appiumSupport,
  fs,
  tempDir
}, function (mocks) {
  afterEach(function () {
    mocks.verify();
  });
  describe('signWithDefaultCert', function () {
    it('should call exec with correct args', (0, _asyncToGenerator2.default)(function* () {
      mocks.helpers.expects("getApksignerForOs").returns(apksignerDummyPath);
      mocks.teen_process.expects("exec").once().withExactArgs(apksignerDummyPath, ['sign', '--key', defaultKeyPath, '--cert', defaultCertPath, selendroidTestApp], {
        cwd: _path.default.dirname(apksignerDummyPath)
      }).returns({});
      yield adb.signWithDefaultCert(selendroidTestApp);
    }));
    it('should fallback to sign.jar if apksigner fails', (0, _asyncToGenerator2.default)(function* () {
      let signPath = _path.default.resolve(helperJarPath, 'sign.jar');

      mocks.helpers.expects("getApksignerForOs").returns(apksignerDummyPath);
      mocks.teen_process.expects("exec").once().withExactArgs(apksignerDummyPath, ['sign', '--key', defaultKeyPath, '--cert', defaultCertPath, selendroidTestApp], {
        cwd: _path.default.dirname(apksignerDummyPath)
      }).throws();
      mocks.helpers.expects("getJavaForOs").returns(javaDummyPath);
      mocks.teen_process.expects("exec").once().withExactArgs(javaDummyPath, ['-jar', signPath, selendroidTestApp, '--override']).returns({});
      yield adb.signWithDefaultCert(selendroidTestApp);
    }));
    it('should throw error for invalid file path', (0, _asyncToGenerator2.default)(function* () {
      let dummyPath = "dummyPath";
      yield adb.signWithDefaultCert(dummyPath).should.eventually.be.rejected;
    }));
  });
  describe('signWithCustomCert', function () {
    it('should call exec with correct args', (0, _asyncToGenerator2.default)(function* () {
      adb.useKeystore = true;
      mocks.helpers.expects("getApksignerForOs").returns(apksignerDummyPath);
      mocks.teen_process.expects("exec").withExactArgs(apksignerDummyPath, ['sign', '--ks', keystorePath, '--ks-key-alias', keyAlias, '--ks-pass', `pass:${password}`, '--key-pass', `pass:${password}`, selendroidTestApp], {
        cwd: _path.default.dirname(apksignerDummyPath)
      }).returns({});
      yield adb.signWithCustomCert(selendroidTestApp);
    }));
    it('should fallback to jarsigner if apksigner fails', (0, _asyncToGenerator2.default)(function* () {
      let jarsigner = _path.default.resolve(javaHome, 'bin', 'jarsigner');

      if (appiumSupport.system.isWindows()) {
        jarsigner = jarsigner + '.exe';
      }

      adb.useKeystore = true;
      mocks.helpers.expects("getApksignerForOs").returns(apksignerDummyPath);
      mocks.teen_process.expects("exec").withExactArgs(apksignerDummyPath, ['sign', '--ks', keystorePath, '--ks-key-alias', keyAlias, '--ks-pass', `pass:${password}`, '--key-pass', `pass:${password}`, selendroidTestApp], {
        cwd: _path.default.dirname(apksignerDummyPath)
      }).throws();
      mocks.helpers.expects("getJavaHome").returns(javaHome);
      mocks.helpers.expects("getJavaForOs").returns(javaDummyPath);
      mocks.teen_process.expects("exec").withExactArgs(javaDummyPath, ['-jar', _path.default.resolve(helperJarPath, 'unsign.jar'), selendroidTestApp]).returns({});
      mocks.teen_process.expects("exec").withExactArgs(jarsigner, ['-sigalg', 'MD5withRSA', '-digestalg', 'SHA1', '-keystore', keystorePath, '-storepass', password, '-keypass', password, selendroidTestApp, keyAlias]).returns({});
      yield adb.signWithCustomCert(selendroidTestApp);
    }));
  });
  describe('getKeystoreMd5', function () {
    it('should call exec with correct args', (0, _asyncToGenerator2.default)(function* () {
      let h = "a-fA-F0-9";

      let keytool = _path.default.resolve(javaHome, 'bin', 'keytool');

      let md5Str = ['.*MD5.*((?:[', h, ']{2}:){15}[', h, ']{2})'].join('');
      let md5 = new RegExp(md5Str, 'mi');
      adb.useKeystore = true;
      mocks.teen_process.expects("exec").once().withExactArgs(keytool, ['-v', '-list', '-alias', keyAlias, '-keystore', keystorePath, '-storepass', password]).returns({});
      yield adb.getKeystoreMd5(keytool, md5);
    }));
  });
  describe.skip('zipAlignApk', function () {
    it('should call exec with correct args', (0, _asyncToGenerator2.default)(function* () {
      let alignedApk = "dummy_path";
      mocks.tempDir.expects('path').once().withExactArgs({
        prefix: 'appium',
        suffix: '.tmp'
      }).returns(alignedApk);
      mocks.adb.expects('initZipAlign').once().withExactArgs().returns("");
      mocks.appiumSupport.expects('mkdirp').once().withExactArgs(_path.default.dirname(alignedApk)).returns({});
      mocks.teen_process.expects("exec").once().withExactArgs(adb.binaries.zipalign, ['-f', '4', selendroidTestApp, alignedApk]);
      mocks.fs.expects("mv").once().withExactArgs(alignedApk, selendroidTestApp, {
        mkdirp: true
      }).returns("");
      yield adb.zipAlignApk(selendroidTestApp);
    }));
  });
  describe('checkApkCert', function () {
    it('should return false for apk not present', (0, _asyncToGenerator2.default)(function* () {
      (yield adb.checkApkCert('dummyPath', 'dummyPackage')).should.be.false;
    }));
    it('should call exec when not using keystore', (0, _asyncToGenerator2.default)(function* () {
      adb.useKeystore = false;
      mocks.helpers.expects("getApksignerForOs").twice().returns(apksignerDummyPath);
      mocks.teen_process.expects("exec").once().withExactArgs(apksignerDummyPath, ['verify', '--print-certs', selendroidTestApp], {
        cwd: _path.default.dirname(apksignerDummyPath)
      }).returns({
        stdout: `Signer #1 certificate DN: EMAILADDRESS=android@android.com, CN=Android, OU=Android, O=Android, L=Mountain View, ST=California, C=US
                   Signer #1 certificate SHA-256 digest: a40da80a59d170caa950cf15c18c454d47a39b26989d8b640ecd745ba71bf5dc
                   Signer #1 certificate SHA-1 digest: 61ed377e85d386a8dfee6b864bd85b0bfaa5af81
                   Signer #1 certificate MD5 digest: e89b158e4bcf988ebd09eb83f5378e87`
      });
      (yield adb.checkApkCert(selendroidTestApp, selendroidTestAppPackage)).should.be.true;
    }));
    it('should fallback to verify.jar if apksigner is not found', (0, _asyncToGenerator2.default)(function* () {
      adb.useKeystore = false;
      mocks.helpers.expects("getApksignerForOs").throws();
      mocks.helpers.expects("getJavaForOs").returns(javaDummyPath);
      mocks.teen_process.expects("exec").withExactArgs(javaDummyPath, ['-jar', _path.default.resolve(helperJarPath, 'verify.jar'), selendroidTestApp]).returns({});
      (yield adb.checkApkCert(selendroidTestApp, selendroidTestAppPackage)).should.be.true;
    }));
    it('should call checkCustomApkCert when using keystore', (0, _asyncToGenerator2.default)(function* () {
      adb.useKeystore = true;
      mocks.adb.expects('checkCustomApkCert').once().withExactArgs(selendroidTestApp, selendroidTestAppPackage).returns("");
      yield adb.checkApkCert(selendroidTestApp, selendroidTestAppPackage);
    }));
  });
}));require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvdW5pdC9hcGstc2lnbmluZy1zcGVjcy5qcyJdLCJuYW1lcyI6WyJjaGFpIiwidXNlIiwiY2hhaUFzUHJvbWlzZWQiLCJzZWxlbmRyb2lkVGVzdEFwcCIsInBhdGgiLCJyZXNvbHZlIiwiaGVscGVycyIsInJvb3REaXIiLCJoZWxwZXJKYXJQYXRoIiwia2V5c3RvcmVQYXRoIiwiZGVmYXVsdEtleVBhdGgiLCJkZWZhdWx0Q2VydFBhdGgiLCJrZXlBbGlhcyIsInBhc3N3b3JkIiwic2VsZW5kcm9pZFRlc3RBcHBQYWNrYWdlIiwiamF2YUR1bW15UGF0aCIsImphdmFIb21lIiwiYXBrc2lnbmVyRHVtbXlQYXRoIiwidGVtcERpciIsImFwcGl1bVN1cHBvcnQiLCJmcyIsImFkYiIsIkFEQiIsImtleXN0b3JlUGFzc3dvcmQiLCJrZXlQYXNzd29yZCIsImRlc2NyaWJlIiwidGVlbl9wcm9jZXNzIiwibW9ja3MiLCJhZnRlckVhY2giLCJ2ZXJpZnkiLCJpdCIsImV4cGVjdHMiLCJyZXR1cm5zIiwib25jZSIsIndpdGhFeGFjdEFyZ3MiLCJjd2QiLCJkaXJuYW1lIiwic2lnbldpdGhEZWZhdWx0Q2VydCIsInNpZ25QYXRoIiwidGhyb3dzIiwiZHVtbXlQYXRoIiwic2hvdWxkIiwiZXZlbnR1YWxseSIsImJlIiwicmVqZWN0ZWQiLCJ1c2VLZXlzdG9yZSIsInNpZ25XaXRoQ3VzdG9tQ2VydCIsImphcnNpZ25lciIsInN5c3RlbSIsImlzV2luZG93cyIsImgiLCJrZXl0b29sIiwibWQ1U3RyIiwiam9pbiIsIm1kNSIsIlJlZ0V4cCIsImdldEtleXN0b3JlTWQ1Iiwic2tpcCIsImFsaWduZWRBcGsiLCJwcmVmaXgiLCJzdWZmaXgiLCJiaW5hcmllcyIsInppcGFsaWduIiwibWtkaXJwIiwiemlwQWxpZ25BcGsiLCJjaGVja0Fwa0NlcnQiLCJmYWxzZSIsInR3aWNlIiwic3Rkb3V0IiwidHJ1ZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFD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LEVBQVNYLGNBQUtDLE9BQUwsQ0FBYUcsYUFBYixFQUE0QixZQUE1QixDQUFULEVBQW9ETCxpQkFBcEQsQ0FEaEMsRUFFRzZCLE9BRkgsQ0FFVyxFQUZYO0FBR0EsYUFBT1gsR0FBRyxDQUFDNEMsWUFBSixDQUFpQjlELGlCQUFqQixFQUFvQ1csd0JBQXBDLENBQVAsRUFBc0UyQixNQUF0RSxDQUE2RUUsRUFBN0UsQ0FBZ0YwQixJQUFoRjtBQUNELEtBWEMsRUFBRjtBQWFBdkMsSUFBQUEsRUFBRSxDQUFDLG9EQUFELGtDQUF1RCxhQUFrQjtBQUN6RVQsTUFBQUEsR0FBRyxDQUFDd0IsV0FBSixHQUFrQixJQUFsQjtBQUVBbEIsTUFBQUEsS0FBSyxDQUFDTixHQUFOLENBQVVVLE9BQVYsQ0FBa0Isb0JBQWxCLEVBQ01FLElBRE4sR0FDYUMsYUFEYixDQUMyQi9CLGlCQUQzQixFQUM4Q1csd0JBRDlDLEVBRU1rQixPQUZOLENBRWMsRUFGZDtBQUdBLFlBQU1YLEdBQUcsQ0FBQzRDLFlBQUosQ0FBaUI5RCxpQkFBakIsRUFBb0NXLHdCQUFwQyxDQUFOO0FBQ0QsS0FQQyxFQUFGO0FBUUQsR0E1Q08sQ0FBUjtBQTZDRCxDQTdLbUIsQ0FBWixDQUFSIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGNoYWkgZnJvbSAnY2hhaSc7XG5pbXBvcnQgY2hhaUFzUHJvbWlzZWQgZnJvbSAnY2hhaS1hcy1wcm9taXNlZCc7XG5pbXBvcnQgQURCIGZyb20gJy4uLy4uJztcbmltcG9ydCAqIGFzIGhlbHBlcnMgZnJvbSAnLi4vLi4vbGliL2hlbHBlcnMuanMnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgKiBhcyB0ZWVuX3Byb2Nlc3MgZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCAqIGFzIGFwcGl1bVN1cHBvcnQgZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHsgd2l0aE1vY2tzIH0gZnJvbSAnYXBwaXVtLXRlc3Qtc3VwcG9ydCc7XG5cblxuY2hhaS51c2UoY2hhaUFzUHJvbWlzZWQpO1xuXG5jb25zdCBzZWxlbmRyb2lkVGVzdEFwcCA9IHBhdGgucmVzb2x2ZShoZWxwZXJzLnJvb3REaXIsICd0ZXN0JywgJ2ZpeHR1cmVzJywgJ3NlbGVuZHJvaWQtdGVzdC1hcHAuYXBrJyksXG4gICAgICBoZWxwZXJKYXJQYXRoID0gcGF0aC5yZXNvbHZlKGhlbHBlcnMucm9vdERpciwgJ2phcnMnKSxcbiAgICAgIGtleXN0b3JlUGF0aCA9IHBhdGgucmVzb2x2ZShoZWxwZXJzLnJvb3REaXIsICd0ZXN0JywgJ2ZpeHR1cmVzJywgJ2FwcGl1bXRlc3Qua2V5c3RvcmUnKSxcbiAgICAgIGRlZmF1bHRLZXlQYXRoID0gcGF0aC5yZXNvbHZlKGhlbHBlcnMucm9vdERpciwgJ2tleXMnLCAndGVzdGtleS5wazgnKSxcbiAgICAgIGRlZmF1bHRDZXJ0UGF0aCA9IHBhdGgucmVzb2x2ZShoZWxwZXJzLnJvb3REaXIsICdrZXlzJywgJ3Rlc3RrZXkueDUwOS5wZW0nKSxcbiAgICAgIGtleUFsaWFzID0gJ2FwcGl1bXRlc3QnLFxuICAgICAgcGFzc3dvcmQgPSAnYW5kcm9pZCcsXG4gICAgICBzZWxlbmRyb2lkVGVzdEFwcFBhY2thZ2UgPSAnaW8uc2VsZW5kcm9pZC50ZXN0YXBwJyxcbiAgICAgIGphdmFEdW1teVBhdGggPSAnamF2YV9kdW1teV9wYXRoJyxcbiAgICAgIGphdmFIb21lID0gJ2phdmFfaG9tZScsXG4gICAgICBhcGtzaWduZXJEdW1teVBhdGggPSAnL3BhdGgvdG8vYXBrc2lnbmVyJyxcbiAgICAgIHRlbXBEaXIgPSBhcHBpdW1TdXBwb3J0LnRlbXBEaXIsXG4gICAgICBmcyA9IGFwcGl1bVN1cHBvcnQuZnM7XG5cbmNvbnN0IGFkYiA9IG5ldyBBREIoKTtcbmFkYi5rZXlzdG9yZVBhdGggPSBrZXlzdG9yZVBhdGg7XG5hZGIua2V5QWxpYXMgPSBrZXlBbGlhcztcbmFkYi5rZXlzdG9yZVBhc3N3b3JkID0gcGFzc3dvcmQ7XG5hZGIua2V5UGFzc3dvcmQgPSBwYXNzd29yZDtcblxuZGVzY3JpYmUoJ3NpZ25pbmcnLCB3aXRoTW9ja3Moe3RlZW5fcHJvY2VzcywgaGVscGVycywgYWRiLCBhcHBpdW1TdXBwb3J0LCBmcywgdGVtcERpcn0sIGZ1bmN0aW9uIChtb2Nrcykge1xuICBhZnRlckVhY2goZnVuY3Rpb24gKCkge1xuICAgIG1vY2tzLnZlcmlmeSgpO1xuICB9KTtcblxuICBkZXNjcmliZSgnc2lnbldpdGhEZWZhdWx0Q2VydCcsIGZ1bmN0aW9uICgpIHtcbiAgICBpdCgnc2hvdWxkIGNhbGwgZXhlYyB3aXRoIGNvcnJlY3QgYXJncycsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIG1vY2tzLmhlbHBlcnMuZXhwZWN0cyhcImdldEFwa3NpZ25lckZvck9zXCIpXG4gICAgICAgIC5yZXR1cm5zKGFwa3NpZ25lckR1bW15UGF0aCk7XG4gICAgICBtb2Nrcy50ZWVuX3Byb2Nlc3MuZXhwZWN0cyhcImV4ZWNcIilcbiAgICAgICAgLm9uY2UoKS53aXRoRXhhY3RBcmdzKGFwa3NpZ25lckR1bW15UGF0aCwgWydzaWduJyxcbiAgICAgICAgICAnLS1rZXknLCBkZWZhdWx0S2V5UGF0aCwgJy0tY2VydCcsIGRlZmF1bHRDZXJ0UGF0aCwgc2VsZW5kcm9pZFRlc3RBcHBdLFxuICAgICAgICAgIHtjd2Q6IHBhdGguZGlybmFtZShhcGtzaWduZXJEdW1teVBhdGgpfSlcbiAgICAgICAgLnJldHVybnMoe30pO1xuICAgICAgYXdhaXQgYWRiLnNpZ25XaXRoRGVmYXVsdENlcnQoc2VsZW5kcm9pZFRlc3RBcHApO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBmYWxsYmFjayB0byBzaWduLmphciBpZiBhcGtzaWduZXIgZmFpbHMnLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICBsZXQgc2lnblBhdGggPSBwYXRoLnJlc29sdmUoaGVscGVySmFyUGF0aCwgJ3NpZ24uamFyJyk7XG4gICAgICBtb2Nrcy5oZWxwZXJzLmV4cGVjdHMoXCJnZXRBcGtzaWduZXJGb3JPc1wiKVxuICAgICAgICAucmV0dXJucyhhcGtzaWduZXJEdW1teVBhdGgpO1xuICAgICAgbW9ja3MudGVlbl9wcm9jZXNzLmV4cGVjdHMoXCJleGVjXCIpXG4gICAgICAgIC5vbmNlKCkud2l0aEV4YWN0QXJncyhhcGtzaWduZXJEdW1teVBhdGgsIFsnc2lnbicsXG4gICAgICAgICAgJy0ta2V5JywgZGVmYXVsdEtleVBhdGgsICctLWNlcnQnLCBkZWZhdWx0Q2VydFBhdGgsIHNlbGVuZHJvaWRUZXN0QXBwXSxcbiAgICAgICAgICB7Y3dkOiBwYXRoLmRpcm5hbWUoYXBrc2lnbmVyRHVtbXlQYXRoKX0pXG4gICAgICAgIC50aHJvd3MoKTtcbiAgICAgIG1vY2tzLmhlbHBlcnMuZXhwZWN0cyhcImdldEphdmFGb3JPc1wiKVxuICAgICAgICAucmV0dXJucyhqYXZhRHVtbXlQYXRoKTtcbiAgICAgIG1vY2tzLnRlZW5fcHJvY2Vzcy5leHBlY3RzKFwiZXhlY1wiKVxuICAgICAgICAub25jZSgpLndpdGhFeGFjdEFyZ3MoamF2YUR1bW15UGF0aCwgWyctamFyJywgc2lnblBhdGgsIHNlbGVuZHJvaWRUZXN0QXBwLCAnLS1vdmVycmlkZSddKVxuICAgICAgICAucmV0dXJucyh7fSk7XG4gICAgICBhd2FpdCBhZGIuc2lnbldpdGhEZWZhdWx0Q2VydChzZWxlbmRyb2lkVGVzdEFwcCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHRocm93IGVycm9yIGZvciBpbnZhbGlkIGZpbGUgcGF0aCcsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCBkdW1teVBhdGggPSBcImR1bW15UGF0aFwiO1xuICAgICAgYXdhaXQgYWRiLnNpZ25XaXRoRGVmYXVsdENlcnQoZHVtbXlQYXRoKS5zaG91bGQuZXZlbnR1YWxseS5iZS5yZWplY3RlZDtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ3NpZ25XaXRoQ3VzdG9tQ2VydCcsIGZ1bmN0aW9uICgpIHtcbiAgICBpdCgnc2hvdWxkIGNhbGwgZXhlYyB3aXRoIGNvcnJlY3QgYXJncycsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIGFkYi51c2VLZXlzdG9yZSA9IHRydWU7XG5cbiAgICAgIG1vY2tzLmhlbHBlcnMuZXhwZWN0cyhcImdldEFwa3NpZ25lckZvck9zXCIpXG4gICAgICAgIC5yZXR1cm5zKGFwa3NpZ25lckR1bW15UGF0aCk7XG4gICAgICBtb2Nrcy50ZWVuX3Byb2Nlc3MuZXhwZWN0cyhcImV4ZWNcIilcbiAgICAgICAgLndpdGhFeGFjdEFyZ3MoYXBrc2lnbmVyRHVtbXlQYXRoLCBbJ3NpZ24nLFxuICAgICAgICAgICctLWtzJywga2V5c3RvcmVQYXRoLFxuICAgICAgICAgICctLWtzLWtleS1hbGlhcycsIGtleUFsaWFzLFxuICAgICAgICAgICctLWtzLXBhc3MnLCBgcGFzczoke3Bhc3N3b3JkfWAsXG4gICAgICAgICAgJy0ta2V5LXBhc3MnLCBgcGFzczoke3Bhc3N3b3JkfWAsXG4gICAgICAgICAgc2VsZW5kcm9pZFRlc3RBcHBdLCB7Y3dkOiBwYXRoLmRpcm5hbWUoYXBrc2lnbmVyRHVtbXlQYXRoKX0pXG4gICAgICAgIC5yZXR1cm5zKHt9KTtcbiAgICAgIGF3YWl0IGFkYi5zaWduV2l0aEN1c3RvbUNlcnQoc2VsZW5kcm9pZFRlc3RBcHApO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBmYWxsYmFjayB0byBqYXJzaWduZXIgaWYgYXBrc2lnbmVyIGZhaWxzJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IGphcnNpZ25lciA9IHBhdGgucmVzb2x2ZShqYXZhSG9tZSwgJ2JpbicsICdqYXJzaWduZXInKTtcbiAgICAgIGlmIChhcHBpdW1TdXBwb3J0LnN5c3RlbS5pc1dpbmRvd3MoKSkge1xuICAgICAgICBqYXJzaWduZXIgPSBqYXJzaWduZXIgKyAnLmV4ZSc7XG4gICAgICB9XG4gICAgICBhZGIudXNlS2V5c3RvcmUgPSB0cnVlO1xuXG4gICAgICBtb2Nrcy5oZWxwZXJzLmV4cGVjdHMoXCJnZXRBcGtzaWduZXJGb3JPc1wiKVxuICAgICAgICAucmV0dXJucyhhcGtzaWduZXJEdW1teVBhdGgpO1xuICAgICAgbW9ja3MudGVlbl9wcm9jZXNzLmV4cGVjdHMoXCJleGVjXCIpXG4gICAgICAgIC53aXRoRXhhY3RBcmdzKGFwa3NpZ25lckR1bW15UGF0aCwgWydzaWduJyxcbiAgICAgICAgICAnLS1rcycsIGtleXN0b3JlUGF0aCxcbiAgICAgICAgICAnLS1rcy1rZXktYWxpYXMnLCBrZXlBbGlhcyxcbiAgICAgICAgICAnLS1rcy1wYXNzJywgYHBhc3M6JHtwYXNzd29yZH1gLFxuICAgICAgICAgICctLWtleS1wYXNzJywgYHBhc3M6JHtwYXNzd29yZH1gLFxuICAgICAgICAgIHNlbGVuZHJvaWRUZXN0QXBwXSwge2N3ZDogcGF0aC5kaXJuYW1lKGFwa3NpZ25lckR1bW15UGF0aCl9KVxuICAgICAgICAudGhyb3dzKCk7XG4gICAgICBtb2Nrcy5oZWxwZXJzLmV4cGVjdHMoXCJnZXRKYXZhSG9tZVwiKVxuICAgICAgICAucmV0dXJucyhqYXZhSG9tZSk7XG4gICAgICBtb2Nrcy5oZWxwZXJzLmV4cGVjdHMoXCJnZXRKYXZhRm9yT3NcIilcbiAgICAgICAgLnJldHVybnMoamF2YUR1bW15UGF0aCk7XG4gICAgICBtb2Nrcy50ZWVuX3Byb2Nlc3MuZXhwZWN0cyhcImV4ZWNcIilcbiAgICAgICAgLndpdGhFeGFjdEFyZ3MoamF2YUR1bW15UGF0aCwgWyctamFyJywgcGF0aC5yZXNvbHZlKGhlbHBlckphclBhdGgsICd1bnNpZ24uamFyJyksIHNlbGVuZHJvaWRUZXN0QXBwXSlcbiAgICAgICAgLnJldHVybnMoe30pO1xuICAgICAgbW9ja3MudGVlbl9wcm9jZXNzLmV4cGVjdHMoXCJleGVjXCIpXG4gICAgICAgIC53aXRoRXhhY3RBcmdzKGphcnNpZ25lciwgWyctc2lnYWxnJywgJ01ENXdpdGhSU0EnLCAnLWRpZ2VzdGFsZycsICdTSEExJyxcbiAgICAgICAgICAnLWtleXN0b3JlJywga2V5c3RvcmVQYXRoLCAnLXN0b3JlcGFzcycsIHBhc3N3b3JkLFxuICAgICAgICAgICcta2V5cGFzcycsIHBhc3N3b3JkLCBzZWxlbmRyb2lkVGVzdEFwcCwga2V5QWxpYXNdKVxuICAgICAgICAucmV0dXJucyh7fSk7XG4gICAgICBhd2FpdCBhZGIuc2lnbldpdGhDdXN0b21DZXJ0KHNlbGVuZHJvaWRUZXN0QXBwKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2dldEtleXN0b3JlTWQ1JywgZnVuY3Rpb24gKCkge1xuICAgIGl0KCdzaG91bGQgY2FsbCBleGVjIHdpdGggY29ycmVjdCBhcmdzJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IGggPSBcImEtZkEtRjAtOVwiO1xuICAgICAgbGV0IGtleXRvb2wgPSBwYXRoLnJlc29sdmUoamF2YUhvbWUsICdiaW4nLCAna2V5dG9vbCcpO1xuICAgICAgbGV0IG1kNVN0ciA9IFsnLipNRDUuKigoPzpbJywgaCwgJ117Mn06KXsxNX1bJywgaCwgJ117Mn0pJ10uam9pbignJyk7XG4gICAgICBsZXQgbWQ1ID0gbmV3IFJlZ0V4cChtZDVTdHIsICdtaScpO1xuICAgICAgYWRiLnVzZUtleXN0b3JlID0gdHJ1ZTtcbiAgICAgIG1vY2tzLnRlZW5fcHJvY2Vzcy5leHBlY3RzKFwiZXhlY1wiKVxuICAgICAgICAub25jZSgpLndpdGhFeGFjdEFyZ3Moa2V5dG9vbCwgWyctdicsICctbGlzdCcsICctYWxpYXMnLCBrZXlBbGlhcyxcbiAgICAgICAgICAnLWtleXN0b3JlJywga2V5c3RvcmVQYXRoLCAnLXN0b3JlcGFzcycsIHBhc3N3b3JkXSlcbiAgICAgICAgLnJldHVybnMoe30pO1xuICAgICAgKGF3YWl0IGFkYi5nZXRLZXlzdG9yZU1kNShrZXl0b29sLCBtZDUpKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgLy8gU2tpcHBpbmcgYXMgdW5hYmxlIHRvIG1vY2sgbWtkaXJwLCB0aGlzIGNhc2UgaXMgY292ZXJlZCBpbiBlMmUgdGVzdHMgZm9yIG5vdy5cbiAgLy8gVE9ETzogZmluZCB3YXlzIHRvIG1vY2sgbWtkaXJwXG4gIGRlc2NyaWJlLnNraXAoJ3ppcEFsaWduQXBrJywgZnVuY3Rpb24gKCkge1xuICAgIGl0KCdzaG91bGQgY2FsbCBleGVjIHdpdGggY29ycmVjdCBhcmdzJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IGFsaWduZWRBcGsgPSBcImR1bW15X3BhdGhcIjtcbiAgICAgIG1vY2tzLnRlbXBEaXIuZXhwZWN0cygncGF0aCcpXG4gICAgICAgIC5vbmNlKCkud2l0aEV4YWN0QXJncyh7cHJlZml4OiAnYXBwaXVtJywgc3VmZml4OiAnLnRtcCd9KVxuICAgICAgICAucmV0dXJucyhhbGlnbmVkQXBrKTtcbiAgICAgIG1vY2tzLmFkYi5leHBlY3RzKCdpbml0WmlwQWxpZ24nKVxuICAgICAgICAub25jZSgpLndpdGhFeGFjdEFyZ3MoKVxuICAgICAgICAucmV0dXJucyhcIlwiKTtcbiAgICAgIG1vY2tzLmFwcGl1bVN1cHBvcnQuZXhwZWN0cygnbWtkaXJwJylcbiAgICAgICAgLm9uY2UoKS53aXRoRXhhY3RBcmdzKHBhdGguZGlybmFtZShhbGlnbmVkQXBrKSlcbiAgICAgICAgLnJldHVybnMoe30pO1xuICAgICAgbW9ja3MudGVlbl9wcm9jZXNzLmV4cGVjdHMoXCJleGVjXCIpXG4gICAgICAgIC5vbmNlKCkud2l0aEV4YWN0QXJncyhhZGIuYmluYXJpZXMuemlwYWxpZ24sIFsnLWYnLCAnNCcsIHNlbGVuZHJvaWRUZXN0QXBwLCBhbGlnbmVkQXBrXSk7XG4gICAgICBtb2Nrcy5mcy5leHBlY3RzKFwibXZcIilcbiAgICAgICAgLm9uY2UoKS53aXRoRXhhY3RBcmdzKGFsaWduZWRBcGssIHNlbGVuZHJvaWRUZXN0QXBwLCB7IG1rZGlycDogdHJ1ZSB9KVxuICAgICAgICAucmV0dXJucyhcIlwiKTtcbiAgICAgIGF3YWl0IGFkYi56aXBBbGlnbkFwayhzZWxlbmRyb2lkVGVzdEFwcCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdjaGVja0Fwa0NlcnQnLCBmdW5jdGlvbiAoKSB7XG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gZmFsc2UgZm9yIGFwayBub3QgcHJlc2VudCcsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIChhd2FpdCBhZGIuY2hlY2tBcGtDZXJ0KCdkdW1teVBhdGgnLCAnZHVtbXlQYWNrYWdlJykpLnNob3VsZC5iZS5mYWxzZTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgY2FsbCBleGVjIHdoZW4gbm90IHVzaW5nIGtleXN0b3JlJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgYWRiLnVzZUtleXN0b3JlID0gZmFsc2U7XG5cbiAgICAgIG1vY2tzLmhlbHBlcnMuZXhwZWN0cyhcImdldEFwa3NpZ25lckZvck9zXCIpXG4gICAgICAgIC50d2ljZSgpLnJldHVybnMoYXBrc2lnbmVyRHVtbXlQYXRoKTtcbiAgICAgIG1vY2tzLnRlZW5fcHJvY2Vzcy5leHBlY3RzKFwiZXhlY1wiKVxuICAgICAgICAub25jZSgpLndpdGhFeGFjdEFyZ3MoYXBrc2lnbmVyRHVtbXlQYXRoLFxuICAgICAgICAgIFsndmVyaWZ5JywgJy0tcHJpbnQtY2VydHMnLCBzZWxlbmRyb2lkVGVzdEFwcF0sXG4gICAgICAgICAge2N3ZDogcGF0aC5kaXJuYW1lKGFwa3NpZ25lckR1bW15UGF0aCl9KVxuICAgICAgICAucmV0dXJucyh7XG4gICAgICAgICAgc3Rkb3V0OiBgU2lnbmVyICMxIGNlcnRpZmljYXRlIEROOiBFTUFJTEFERFJFU1M9YW5kcm9pZEBhbmRyb2lkLmNvbSwgQ049QW5kcm9pZCwgT1U9QW5kcm9pZCwgTz1BbmRyb2lkLCBMPU1vdW50YWluIFZpZXcsIFNUPUNhbGlmb3JuaWEsIEM9VVNcbiAgICAgICAgICAgICAgICAgICBTaWduZXIgIzEgY2VydGlmaWNhdGUgU0hBLTI1NiBkaWdlc3Q6IGE0MGRhODBhNTlkMTcwY2FhOTUwY2YxNWMxOGM0NTRkNDdhMzliMjY5ODlkOGI2NDBlY2Q3NDViYTcxYmY1ZGNcbiAgICAgICAgICAgICAgICAgICBTaWduZXIgIzEgY2VydGlmaWNhdGUgU0hBLTEgZGlnZXN0OiA2MWVkMzc3ZTg1ZDM4NmE4ZGZlZTZiODY0YmQ4NWIwYmZhYTVhZjgxXG4gICAgICAgICAgICAgICAgICAgU2lnbmVyICMxIGNlcnRpZmljYXRlIE1ENSBkaWdlc3Q6IGU4OWIxNThlNGJjZjk4OGViZDA5ZWI4M2Y1Mzc4ZTg3YCxcbiAgICAgICAgfSk7XG4gICAgICAoYXdhaXQgYWRiLmNoZWNrQXBrQ2VydChzZWxlbmRyb2lkVGVzdEFwcCwgc2VsZW5kcm9pZFRlc3RBcHBQYWNrYWdlKSkuc2hvdWxkLmJlLnRydWU7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGZhbGxiYWNrIHRvIHZlcmlmeS5qYXIgaWYgYXBrc2lnbmVyIGlzIG5vdCBmb3VuZCcsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIGFkYi51c2VLZXlzdG9yZSA9IGZhbHNlO1xuXG4gICAgICBtb2Nrcy5oZWxwZXJzLmV4cGVjdHMoXCJnZXRBcGtzaWduZXJGb3JPc1wiKVxuICAgICAgICAudGhyb3dzKCk7XG4gICAgICBtb2Nrcy5oZWxwZXJzLmV4cGVjdHMoXCJnZXRKYXZhRm9yT3NcIilcbiAgICAgICAgLnJldHVybnMoamF2YUR1bW15UGF0aCk7XG4gICAgICBtb2Nrcy50ZWVuX3Byb2Nlc3MuZXhwZWN0cyhcImV4ZWNcIilcbiAgICAgICAgLndpdGhFeGFjdEFyZ3MoamF2YUR1bW15UGF0aCwgWyctamFyJywgcGF0aC5yZXNvbHZlKGhlbHBlckphclBhdGgsICd2ZXJpZnkuamFyJyksIHNlbGVuZHJvaWRUZXN0QXBwXSlcbiAgICAgICAgLnJldHVybnMoe30pO1xuICAgICAgKGF3YWl0IGFkYi5jaGVja0Fwa0NlcnQoc2VsZW5kcm9pZFRlc3RBcHAsIHNlbGVuZHJvaWRUZXN0QXBwUGFja2FnZSkpLnNob3VsZC5iZS50cnVlO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBjYWxsIGNoZWNrQ3VzdG9tQXBrQ2VydCB3aGVuIHVzaW5nIGtleXN0b3JlJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgYWRiLnVzZUtleXN0b3JlID0gdHJ1ZTtcblxuICAgICAgbW9ja3MuYWRiLmV4cGVjdHMoJ2NoZWNrQ3VzdG9tQXBrQ2VydCcpXG4gICAgICAgICAgIC5vbmNlKCkud2l0aEV4YWN0QXJncyhzZWxlbmRyb2lkVGVzdEFwcCwgc2VsZW5kcm9pZFRlc3RBcHBQYWNrYWdlKVxuICAgICAgICAgICAucmV0dXJucyhcIlwiKTtcbiAgICAgIGF3YWl0IGFkYi5jaGVja0Fwa0NlcnQoc2VsZW5kcm9pZFRlc3RBcHAsIHNlbGVuZHJvaWRUZXN0QXBwUGFja2FnZSk7XG4gICAgfSk7XG4gIH0pO1xufSkpO1xuIl0sImZpbGUiOiJ0ZXN0L3VuaXQvYXBrLXNpZ25pbmctc3BlY3MuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
